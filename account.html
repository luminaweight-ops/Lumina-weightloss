<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Account | Lumina Weight</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  :root {
    --lw-mint: #22c55e;
    --lw-bg: #f3f4f6;
    --lw-dark: #0f172a;
    --lw-muted: #64748b;
  }

  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--lw-bg);
    color: var(--lw-dark);
    margin: 0;
  }

  .navbar {
    background: #ffffff !important;
    box-shadow: 0 10px 25px rgba(15, 23, 42, 0.06);
  }
  .navbar-brand img {
    height: 36px;
    margin-right: 10px;
  }
  .navbar-brand span {
    font-weight: 700;
    font-size: 1.15rem;
  }
  .nav-link {
    font-weight: 500;
    color: var(--lw-muted) !important;
  }
  .nav-link.active,
  .nav-link:hover {
    color: var(--lw-dark) !important;
  }

  .page-hero {
    padding: 80px 0 40px;
    background: radial-gradient(circle at top left, #ecfdf5, #e0f2fe 40%, #eef2ff 100%);
  }

  .section-title {
    font-size: 2rem;
    font-weight: 800;
  }
  .section-subtitle {
    color: var(--lw-muted);
    max-width: 560px;
  }

  .order-card {
    border-radius: 18px;
    background: #ffffff;
    box-shadow: 0 10px 26px rgba(15,23,42,0.06);
    padding: 18px 20px;
  }

  .badge-status {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: .09em;
  }

  footer {
    background: #020617;
    color: #9ca3af;
    padding: 22px 0;
    font-size: 0.9rem;
    margin-top: 40px;
  }
</style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center" href="index.html#home">
      <img src="LuminaLogoBlack.png" alt="Lumina Weight Logo">
      <span>Lumina Weight</span>
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNav">
      <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-3">
        <li class="nav-item"><a class="nav-link" href="index.html#home">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="products.html">Products</a></li>
        <li class="nav-item"><a class="nav-link" href="index.html#reviews">Reviews</a></li>
        <li class="nav-item"><a class="nav-link" href="index.html#contact">Contact</a></li>
        <li class="nav-item">
          <button id="logout-btn" class="btn btn-outline-secondary btn-sm rounded-pill">
            Logout
          </button>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- HERO -->
<section class="page-hero">
  <div class="container">
    <h1 class="section-title mb-2">My Account</h1>
    <p class="section-subtitle mb-0" id="account-greeting">
      Loading your accountâ€¦
    </p>
  </div>
</section>

<!-- ORDERS -->
<section class="py-4">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="h5 mb-0">Order History</h2>
      <small id="account-status" class="text-muted"></small>
    </div>

    <div id="orders-list"></div>
  </div>
</section>

<footer class="text-center">
  <div class="container">
    <p class="mb-0">Â© 2025 Lumina Weight â€¢ Research Purposes Only â€¢ Not For Human Consumption</p>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://qketnqhfjfxbqiuqevnh.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrZXRucWhmamZ4YnFpdXFldm5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NjkzMzAsImV4cCI6MjA4MDI0NTMzMH0.JIrgLIwWIA5Gwu9K4BsgS0Y_jyax2G6irqkaf35aPys";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const greetingEl = document.getElementById('account-greeting');
  const statusEl   = document.getElementById('account-status');
  const ordersEl   = document.getElementById('orders-list');
  const logoutBtn  = document.getElementById('logout-btn');

  function getStatusBadge(status) {
    const s = (status || 'Pending').toLowerCase();
    if (s === 'paid')   return '<span class="badge bg-success-subtle text-success badge-status">PAID</span>';
    if (s === 'shipped')return '<span class="badge bg-primary-subtle text-primary badge-status">SHIPPED</span>';
    if (s === 'cancelled')return '<span class="badge bg-danger-subtle text-danger badge-status">CANCELLED</span>';
    return '<span class="badge bg-warning-subtle text-warning badge-status">PENDING</span>';
  }

  async function loadAccount() {
    const { data: { user }, error } = await supabaseClient.auth.getUser();

    if (error || !user) {
  // ðŸ”’ HARD PROTECTION: no access if not logged in
  window.location.href = 'index.html';
  return;
}

    greetingEl.textContent = `Signed in as ${user.email}`;
    statusEl.textContent = 'Loading ordersâ€¦';

    const { data: orders, error: ordersError } = await supabaseClient
  .from('Orders')
  .select('*')
  .eq('user_id', user.id)
  .order('created_at', { ascending: false });

    if (ordersError) {
      statusEl.textContent = 'Could not load orders.';
      console.error(ordersError);
      return;
    }

    if (!orders || orders.length === 0) {
      statusEl.textContent = 'No orders found yet.';
      ordersEl.innerHTML = `
        <div class="alert alert-light border text-muted">
          When you place an order while logged in, it will appear here for reference.
        </div>
      `;
      return;
    }

    statusEl.textContent = `${orders.length} order${orders.length > 1 ? 's' : ''}`;

    ordersEl.innerHTML = orders.map(order => {
      const created = new Date(order.created_at).toLocaleString();
      const total   = Number(order.total_amount || 0).toFixed(2);
      const ref     = order.reference || (order.id ? order.id.slice(0,8) + 'â€¦' : 'N/A');

      let itemsHtml = '';
      if (order.details && order.details.items && Array.isArray(order.details.items)) {
        itemsHtml = order.details.items.map(item => `
          <div class="small text-muted">
            ${item.qty} Ã— ${item.name} â€“ Â£${Number(item.price_each || 0).toFixed(2)} each
          </div>
        `.trim()).join('');
      }

      return `
        <div class="order-card mb-3">
          <div class="d-flex justify-content-between flex-wrap gap-2">
            <div>
              <div class="small text-muted">Order reference</div>
              <div class="fw-semibold">${ref}</div>
              <div class="small text-muted mt-1">${created}</div>
            </div>
            <div class="text-end">
              ${getStatusBadge(order.status)}
              <div class="fw-bold fs-5 mt-1">Â£${total}</div>
            </div>
          </div>
          ${itemsHtml ? `<div class="mt-2">${itemsHtml}</div>` : ''}
        </div>
      `;
    }).join('');
  }

  logoutBtn.addEventListener('click', async () => {
    await supabaseClient.auth.signOut();
    window.location.href = 'index.html';
  });

  loadAccount();
</script>
</body>
</html>

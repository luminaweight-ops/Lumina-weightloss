<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout - Lumina Weight</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  :root {
    --lw-mint: #22c55e;
    --lw-mint-soft: #ecfdf5;
    --lw-blue-soft: #e0f2fe;
    --lw-purple-soft: #eef2ff;
    --lw-dark: #0f172a;
    --lw-muted: #64748b;
    --lw-bg: #f3f4f6;
  }

  body {
    background: var(--lw-bg);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }

  .hero {
    background: radial-gradient(circle at top left, var(--lw-mint-soft), #e0f2fe 40%, var(--lw-purple-soft) 100%);
    color: var(--lw-dark);
    padding: 80px 0 70px;
    text-align: center;
  }
  .hero h1 {
    font-weight: 800;
  }
  .hero p {
    color: var(--lw-muted);
    max-width: 500px;
    margin: 0 auto 10px;
  }
  .btn-outline-light {
    border-radius: 999px;
    border-color: rgba(148,163,184,0.6);
    color: var(--lw-muted);
  }
  .btn-outline-light:hover {
    background: #ffffff;
    color: var(--lw-dark);
  }

  .card {
    border-radius: 24px;
    border: 0;
    box-shadow: 0 20px 45px rgba(15,23,42,0.10);
  }

  .form-control {
    border-radius: 12px;
  }

  #final-total {
    color: #16a34a;
  }

  .modal-content {
    border-radius: 20px;
  }
  .modal-header {
    background: var(--lw-mint);
    color: #ffffff;
  }
</style>
</head>
<body>

<div class="hero">
  <div class="container">
    <h1 class="display-5 fw-bold">Checkout</h1>
    <p>Enter your delivery details so we can generate your order reference and payment info.</p>
    <button class="btn btn-outline-light btn-sm mt-2" onclick="backToShop()">‚Üê Back to shop</button>
  </div>
</div>

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body p-5">
          <form id="addressForm">
            <h4 class="mb-4 fw-semibold">Delivery address</h4>
            <div class="row g-3">
              <div class="col-md-6">
                <input type="text" class="form-control" id="fullName" placeholder="Full name" required>
              </div>
              <div class="col-md-6">
                <input type="tel" class="form-control" id="phone" placeholder="Phone number" required>
              </div>
              <div class="col-12">
                <input type="email" class="form-control" id="email" placeholder="Email address" required>
              </div>
              <div class="col-12">
                <input type="text" class="form-control" id="address1" placeholder="Address line 1" required>
              </div>
              <div class="col-12">
                <input type="text" class="form-control" id="address2" placeholder="Address line 2 (optional)">
              </div>
              <div class="col-md-6">
                <input type="text" class="form-control" id="city" placeholder="City" required>
              </div>
              <div class="col-md-6">
                <input type="text" class="form-control" id="postcode" placeholder="Postcode" required>
              </div>
            </div>

            <hr class="my-4">

            <h4 class="fw-semibold mb-3">Order summary</h4>
            <div id="order-summary"></div>

            <!-- Bundle info on checkout -->
            <div id="bundle-message" class="small text-warning mt-2"></div>
            <div class="d-flex justify-content-between small text-success mt-1"
                 id="bundle-row" style="display:none;">
              <span>Bundle discount</span>
              <span id="bundle-amount">-¬£0.00</span>
            </div>

            <div class="d-flex justify-content-between fs-4 fw-bold mt-3">
              <span>Total:</span>
              <span id="final-total">¬£0.00</span>
            </div>

            <button type="submit" class="btn btn-success btn-lg w-100 mt-4 rounded-pill">
              Confirm order ‚Üí Payment details
            </button>
            <div id="checkout-status" class="small text-muted mt-2"></div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PAYMENT MODAL -->
<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Order confirmed</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-success">
          Thank you <strong id="customerName"></strong>! Your order has been recorded.
        </div>

        <h5 class="fw-semibold">Your order</h5>
        <div id="payment-summary" class="mb-3"></div>

        <h4 class="text-success mb-1">
          Total: <span id="payment-total"></span>
        </h4>
        <p id="payment-discount" class="text-success small mb-3" style="display:none;"></p>

        <p class="mb-1">
          Your payment reference: 
          <strong id="order-ref" class="text-primary fw-bold"></strong>
        </p>
        <p class="text-muted mb-0">
          Order confirmed<br>
          Payment instructions have been sent to your email.<br>
          Please use the reference code <strong>ONLY</strong> when making your bank transfer.<br><br>
          Thanks for choosing Lumina Weight.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-success" onclick="backToShop()">Back to shop</button>
      </div>
    </div>
  </div>
</div>

<!-- EmailJS + Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  (function() {
    emailjs.init('uZOuTrBdIAc6AmKjo');
  })();

  // Supabase client
  const SUPABASE_URL = "https://qketnqhfjfxbqiuqevnh.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrZXRucWhmamZ4YnFpdXFldm5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NjkzMzAsImV4cCI6MjA4MDI0NTMzMH0.JIrgLIwWIA5Gwu9K4BsgS0Y_jyax2G6irqkaf35aPys";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
  

<script>
let cart = [];
let total = 0;

// ---------- BUNDLE CALCULATOR (same logic as cart) ----------
function calculateBundle(cart) {
  let vialQty = 0, penQty = 0;
  let vialTotal = 0, penTotal = 0, otherTotal = 0;

  cart.forEach(item => {
    const line = (item.price || 0) * (item.qty || 0);
    const name = (item.name || '').toLowerCase();

    if (name.includes('vial')) {
      vialQty  += item.qty;
      vialTotal += line;
    } else if (name.includes('pen')) {
      penQty   += item.qty;
      penTotal += line;
    } else {
      otherTotal += line;
    }
  });

  const baseTotal = vialTotal + penTotal + otherTotal;
  let discount = 0;
  const messages = [];

  // VIAL bundles
  if (vialQty >= 3) {
    const d = vialTotal * 0.10; // 10% off vials
    discount += d;
    messages.push('10% multi-vial bundle discount applied.');
  } else if (vialQty === 2) {
    const d = vialTotal * 0.05; // 5% off vials
    discount += d;
    messages.push('5% vial bundle discount applied (2 vials).');
  }

  // PEN bundles
  if (penQty >= 2) {
    const d = penTotal * 0.05; // 5% off pens
    discount += d;
    messages.push('5% pen bundle discount applied (2+ pens).');
  }

  const finalTotal = Math.max(0, baseTotal - discount);

  return {
    baseTotal,
    discount,
    finalTotal,
    messages
  };
}

// ---------- CART / RECOVERY HELPERS ----------
function getCartFromUrlOrStorage() {
  const params = new URLSearchParams(window.location.search);
  const urlCart = params.get('cart');
  if (urlCart) {
    try {
      const parsed = JSON.parse(decodeURIComponent(urlCart));
      localStorage.setItem('cart', JSON.stringify(parsed));
      return parsed;
    } catch (e) {
      console.error('Error parsing cart from URL', e);
    }
  }
  try {
    const saved = localStorage.getItem('cart');
    if (saved) return JSON.parse(saved);
  } catch (e) {
    console.error('Error reading cart from localStorage', e);
  }
  return [];
}

async function maybeRecoverCart() {
  const params = new URLSearchParams(window.location.search);
  const token = params.get('recover');
  if (!token) return;

  try {
    const { data, error } = await supabaseClient
      .from('AbandonedCheckouts')
      .select('cart, status')
      .eq('recovery_token', token)
      .single();

    if (error) {
      console.error('Recovery token lookup failed', error);
      return;
    }

    if (data && data.cart) {
      localStorage.setItem('cart', JSON.stringify(data.cart));
      // Optional: mark as recovered
      await supabaseClient
        .from('AbandonedCheckouts')
        .update({ status: 'recovered' })
        .eq('recovery_token', token);

      // Clean URL
      const url = new URL(window.location.href);
      url.searchParams.delete('recover');
      url.searchParams.delete('cart');
      window.history.replaceState({}, '', url.toString());
    }
  } catch (e) {
    console.error('Unexpected recovery error', e);
  }
}

function renderOrderSummary() {
  if (!cart.length) return;

  const bundle = calculateBundle(cart);
  total = bundle.finalTotal;

  const summaryEl       = document.getElementById('order-summary');
  const totalEl         = document.getElementById('final-total');
  const bundleRow       = document.getElementById('bundle-row');
  const bundleAmountEl  = document.getElementById('bundle-amount');
  const bundleMessageEl = document.getElementById('bundle-message');

  summaryEl.innerHTML = cart.map(i => `
    <div class="d-flex justify-content-between py-2 border-bottom">
      <span>${i.qty} √ó ${i.name}</span>
      <span>¬£${(i.price * i.qty).toFixed(2)}</span>
    </div>
  `).join('');

  if (bundle.discount > 0) {
    if (bundleRow) bundleRow.style.display = 'flex';
    if (bundleAmountEl) bundleAmountEl.textContent = `-¬£${bundle.discount.toFixed(2)}`;
    if (bundleMessageEl) bundleMessageEl.textContent = bundle.messages.join(' ');
  } else {
    if (bundleRow) bundleRow.style.display = 'none';
    if (bundleAmountEl) bundleAmountEl.textContent = '-¬£0.00';
    if (bundleMessageEl) bundleMessageEl.textContent = '';
  }

  if (totalEl) totalEl.textContent = `¬£${bundle.finalTotal.toFixed(2)}`;
}

function buildItemsText() {
  if (!cart.length) return 'No items (cart empty).';
  return cart.map(i => `${i.qty} √ó ${i.name} ‚Äî ¬£${(i.price * i.qty).toFixed(2)}`).join('\n');
}

function buildAddressText(details) {
  return [
    details.address1,
    details.address2,
    details.city,
    details.postcode
  ].filter(Boolean).join('\n');
}

function clearStoredCart() {
  try {
    localStorage.removeItem('cart');
  } catch (e) {
    console.warn('Could not clear localStorage cart', e);
  }
}

function createRecoveryToken() {
  if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
  return 'token_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
}

function getCartSummaryText() {
  return buildItemsText();
}

// ---------- SUPABASE ORDER SAVE ----------
async function saveOrderToSupabase(details) {
  try {
    const { data, error } = await supabaseClient.auth.getUser();
    
    // Get user_id if logged in, otherwise null for guest orders
    const userId = (error || !data || !data.user) ? null : data.user.id;

    const orderDetails = {
      customer: {
        name: details.name,
        email: details.email,
        phone: details.phone,
        address1: details.address1,
        address2: details.address2,
        city: details.city,
        postcode: details.postcode
      },
      items: cart.map(i => ({
        name: i.name,
        qty: i.qty,
        price_each: i.price,
        line_total: i.price * i.qty
      })),
      reference: details.ref
    };

    const { error: insertError } = await supabaseClient
      .from('Orders')
      .insert({
        user_id: userId,  // This will be null for guest orders
        total_amount: total,
        status: 'Pending',
        reference: details.ref,
        details: orderDetails
      });

    if (insertError) {
      console.error('Error saving order to Supabase:', insertError);
    } else {
      console.log('‚úÖ Order saved to Supabase', userId ? '(User order)' : '(Guest order)');
    }
  } catch (err) {
    console.error('Unexpected error saving order to Supabase:', err);
  }
}

// ---------- ABANDONED CHECKOUT SAVE ----------
async function saveAbandonedCheckout(details, recoveryToken) {
  try {
    const { error } = await supabaseClient
      .from('AbandonedCheckouts')
      .insert({
        email: details.email,
        name: details.name,
        cart,
        recovery_token: recoveryToken,
        status: 'pending',
        total_amount: total,
        reference: details.ref
      });

    if (error) {
      console.error('Error saving abandoned checkout:', error);
    } else {
      console.log('‚úÖ Abandoned checkout saved');
    }
  } catch (e) {
    console.error('Unexpected error saving abandoned checkout', e);
  }
}

// ---------- EMAILS ----------

// üì• ADMIN EMAIL TO YOU ‚Äì template_juevvvd
function sendAdminEmail(details) {
  const itemsText = buildItemsText();
  const addressText = buildAddressText(details);

  emailjs.send(
    'service_i5zi096',
    'template_juevvvd',
    {
      to_email: 'luminaweight@gmail.com',
      customer_name: details.name,
      customer_phone: details.phone,
      customer_address: addressText,
      order_reference: details.ref,
      order_items: itemsText,
      order_total: `¬£${total.toFixed(2)}`
    }
  )
  .then(res => console.log('‚úÖ Admin order email sent', res.status))
  .catch(err => console.error('‚ùå Admin email failed', err));
}

// üßë‚Äçüíª CUSTOMER EMAIL ‚Äì template_x5lnd1u
function sendCustomerEmail(details) {
  const itemsText = buildItemsText();
  const addressText = buildAddressText(details);

  emailjs.send(
    'service_i5zi096',
    'template_x5lnd1u',
    {
      to_email: details.email,
      customer_email: details.email,
      customer_name: details.name,
      customer_address: addressText,
      order_reference: details.ref,
      order_items: itemsText,
      order_total: `¬£${total.toFixed(2)}`
    }
  )
  .then(res => console.log('‚úÖ Customer confirmation email sent', res.status))
  .catch(err => console.error('‚ùå Customer email failed', err));
}

// üíå ABANDONED / RECOVERY EMAIL ‚Äì template_guh3ord
function sendAbandonedEmail(details, recoveryLink) {
  const cartSummary = getCartSummaryText();

  return emailjs.send(
    'service_i5zi096',
    'template_guh3ord', // abandoned checkout template
    {
      to_email: details.email,
      customer_name: details.name || 'there',
      order_items: cartSummary,
      recovery_link: recoveryLink
    }
  )
  .then(res => console.log('‚úÖ Abandoned / recovery email sent', res.status))
  .catch(err => console.error('‚ùå Abandoned email failed', err));
}

// ---------- FORM SUBMIT ----------
const checkoutStatus = document.getElementById('checkout-status');

document.getElementById('addressForm').onsubmit = async function(e) {
  e.preventDefault();

  const btn = this.querySelector('button[type="submit"]');

  const name = document.getElementById('fullName').value.trim() || 'Customer';
  const phone = document.getElementById('phone').value.trim();
  const email = document.getElementById('email').value.trim();
  const address1 = document.getElementById('address1').value.trim();
  const address2 = document.getElementById('address2').value.trim();
  const city = document.getElementById('city').value.trim();
  const postcode = document.getElementById('postcode').value.trim();
  const ref = 'LW' + Date.now().toString().slice(-6);

  if (!email || !cart.length) {
    checkoutStatus.textContent = 'Please ensure your cart and email are valid.';
    checkoutStatus.classList.add('text-danger');
    return;
  }

  // Recalculate bundle & total right before saving / emailing
  const bundle = calculateBundle(cart);
  total = bundle.finalTotal;

  const details = { name, phone, email, address1, address2, city, postcode, ref };

  // Fill modal
  document.getElementById('customerName').textContent = name;
  document.getElementById('payment-summary').innerHTML = cart.map(i => `
    <div class="d-flex justify-content-between">
      <span>${i.qty} √ó ${i.name}</span>
      <span>¬£${(i.price*i.qty).toFixed(2)}</span>
    </div>
  `).join('');
  document.getElementById('payment-total').textContent = `¬£${total.toFixed(2)}`;

  const paymentDiscountEl = document.getElementById('payment-discount');
  if (paymentDiscountEl) {
    if (bundle.discount > 0) {
      paymentDiscountEl.style.display = 'block';
      paymentDiscountEl.textContent = `Bundle discount applied: -¬£${bundle.discount.toFixed(2)}`;
    } else {
      paymentDiscountEl.style.display = 'none';
      paymentDiscountEl.textContent = '';
    }
  }

  document.getElementById('order-ref').textContent = ref;

  // Abandoned / recovery setup
  const recoveryToken = createRecoveryToken();
  const recoveryLink  = `https://luminaweight.xyz/checkout.html?recover=${encodeURIComponent(recoveryToken)}`;

  checkoutStatus.textContent = '';
  checkoutStatus.classList.remove('text-danger', 'text-success');
  btn.disabled = true;
  btn.textContent = 'Processing...';

  try {
  // 1. SAVE THE ACTUAL ORDER FIRST (for both guest and logged-in users)
  await saveOrderToSupabase(details);

  // 2. Save abandoned checkout for recovery tracking
  await saveAbandonedCheckout(details, recoveryToken);

  // 3. Send all emails
  sendAdminEmail(details);
  sendCustomerEmail(details);
  await sendAbandonedEmail(details, recoveryLink);

  // 4. Clear cart
  clearStoredCart();

  // 5. Show success modal
  new bootstrap.Modal(document.getElementById('paymentModal')).show();

  checkoutStatus.textContent = 'We've emailed your payment instructions and order link.';
  checkoutStatus.classList.add('text-success');
  } catch (err) {
    console.error('Checkout flow error', err);
    checkoutStatus.textContent = 'There was a problem handling your order. Please try again.';
    checkoutStatus.classList.add('text-danger');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Confirm order ‚Üí Payment details';
  }
};

function backToShop() {
  window.location.href = 'index.html';
}

// ---------- INIT ----------
(async function initCheckout() {
  await maybeRecoverCart();
  cart = getCartFromUrlOrStorage();

  if (!cart.length) {
    alert('Your cart is empty! Taking you back to the shop.');
    window.location.href = 'index.html';
    return;
  }

  renderOrderSummary();
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

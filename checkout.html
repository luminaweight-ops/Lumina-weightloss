<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout - Lumina Weight</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  :root {
    --lw-mint: #22c55e;
    --lw-mint-soft: #ecfdf5;
    --lw-blue-soft: #e0f2fe;
    --lw-purple-soft: #eef2ff;
    --lw-dark: #0f172a;
    --lw-muted: #64748b;
    --lw-bg: #f3f4f6;
  }

  body {
    background: var(--lw-bg);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }

  .hero {
    background: radial-gradient(circle at top left, var(--lw-mint-soft), #e0f2fe 40%, var(--lw-purple-soft) 100%);
    padding: 80px 0 70px;
    text-align: center;
  }

  .card {
    border-radius: 24px;
    border: 0;
    box-shadow: 0 20px 45px rgba(15,23,42,0.10);
  }

  .form-control { border-radius: 12px; }
  #final-total { color: #16a34a; }
</style>
</head>
<body>

<div class="hero">
  <div class="container">
    <h1 class="display-5 fw-bold">Checkout</h1>
    <p class="text-muted">Enter your delivery details to receive payment instructions.</p>
    <button class="btn btn-outline-secondary btn-sm" onclick="backToShop()">← Back to shop</button>
  </div>
</div>

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body p-5">
          <form id="addressForm">

            <h4 class="fw-semibold mb-4">Delivery address</h4>

            <div class="row g-3">
              <div class="col-md-6"><input class="form-control" id="fullName" placeholder="Full name" required></div>
              <div class="col-md-6"><input class="form-control" id="phone" placeholder="Phone number" required></div>
              <div class="col-12"><input class="form-control" id="email" placeholder="Email address" required></div>
              <div class="col-12"><input class="form-control" id="address1" placeholder="Address line 1" required></div>
              <div class="col-12"><input class="form-control" id="address2" placeholder="Address line 2 (optional)"></div>
              <div class="col-md-6"><input class="form-control" id="city" placeholder="City" required></div>
              <div class="col-md-6"><input class="form-control" id="postcode" placeholder="Postcode" required></div>
            </div>

            <hr class="my-4">

            <h4 class="fw-semibold mb-3">Order summary</h4>
            <div id="order-summary"></div>

            <div class="d-flex justify-content-between fs-4 fw-bold mt-3">
              <span>Total:</span>
              <span id="final-total">£0.00</span>
            </div>

            <button type="submit" class="btn btn-success btn-lg w-100 mt-4 rounded-pill">
              Confirm order → Payment details
            </button>

            <div id="checkout-status" class="small mt-2 text-muted"></div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PAYMENT MODAL -->
<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Order confirmed</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-success">
          Thank you <strong id="customerName"></strong>! Your order has been recorded.
        </div>

        <div id="payment-summary" class="mb-3"></div>

        <h4 class="text-success">Total: <span id="payment-total"></span></h4>

        <p class="mt-3">
          Payment reference:<br>
          <strong id="order-ref" class="text-primary"></strong>
        </p>

        <p class="text-muted">
          Payment instructions have been sent to your email.<br>
          Please use the reference exactly as shown.
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-success" onclick="backToShop()">Back to shop</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
emailjs.init('uZOuTrBdIAc6AmKjo');

const supabaseClient = supabase.createClient(
  "https://qketnqhfjfxbqiuqevnh.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
);

let cart = [];
let total = 0;

function getCart() {
  try {
    return JSON.parse(localStorage.getItem('cart')) || [];
  } catch { return []; }
}

function renderOrderSummary() {
  const el = document.getElementById('order-summary');
  total = cart.reduce((s,i)=>s+(i.price*i.qty),0);

  el.innerHTML = cart.map(i=>`
    <div class="d-flex justify-content-between py-2 border-bottom">
      <span>${i.qty} × ${i.name}</span>
      <span>£${(i.price*i.qty).toFixed(2)}</span>
    </div>
  `).join('');

  document.getElementById('final-total').textContent = `£${total.toFixed(2)}`;
}

document.getElementById('addressForm').onsubmit = async function(e){
  e.preventDefault();

  const name = fullName.value.trim();
  const ref = 'LW' + Date.now().toString().slice(-6);

  document.getElementById('customerName').textContent = name;
  document.getElementById('payment-summary').innerHTML = document.getElementById('order-summary').innerHTML;
  document.getElementById('payment-total').textContent = `£${total.toFixed(2)}`;
  document.getElementById('order-ref').textContent = ref;

  new bootstrap.Modal(paymentModal).show();
  localStorage.removeItem('cart');
};

function backToShop(){
  window.location.href = 'index.html';
}

cart = getCart();
if(!cart.length){ alert('Cart empty'); backToShop(); }
renderOrderSummary();
</script>

</body>
</html>

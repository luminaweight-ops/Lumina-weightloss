<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout - Lumina Weight</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  :root {
    --lw-mint: #22c55e;
    --lw-mint-soft: #ecfdf5;
    --lw-blue-soft: #e0f2fe;
    --lw-purple-soft: #eef2ff;
    --lw-dark: #0f172a;
    --lw-muted: #64748b;
    --lw-bg: #f3f4f6;
  }

  body {
    background: var(--lw-bg);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }

  .hero {
    background: radial-gradient(circle at top left, var(--lw-mint-soft), #e0f2fe 40%, var(--lw-purple-soft) 100%);
    color: var(--lw-dark);
    padding: 80px 0 70px;
    text-align: center;
  }
  .hero h1 { font-weight: 800; }
  .hero p {
    color: var(--lw-muted);
    max-width: 500px;
    margin: 0 auto 10px;
  }
  .btn-outline-light {
    border-radius: 999px;
    border-color: rgba(148,163,184,0.6);
    color: var(--lw-muted);
  }
  .btn-outline-light:hover {
    background: #ffffff;
    color: var(--lw-dark);
  }

  .card {
    border-radius: 24px;
    border: 0;
    box-shadow: 0 20px 45px rgba(15,23,42,0.10);
  }

  .form-control { border-radius: 12px; }

  #final-total { color: #16a34a; }

  .modal-content { border-radius: 20px; }
  .modal-header {
    background: var(--lw-mint);
    color: #ffffff;
  }

  .addon-row {
    margin-top: 6px;
  }
  .addon-row label{
    font-size: 0.85rem;
    color: var(--lw-muted);
    margin-right: 8px;
  }
</style>
</head>
<body>

<div class="hero">
  <div class="container">
    <h1 class="display-5 fw-bold">Checkout</h1>
    <p>Enter your delivery details so we can generate your order reference and payment info.</p>
    <button class="btn btn-outline-light btn-sm mt-2" onclick="backToShop()">← Back to shop</button>
  </div>
</div>

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body p-5">
          <form id="addressForm">
            <h4 class="mb-4 fw-semibold">Delivery address</h4>
            <div class="row g-3">
              <div class="col-md-6">
                <input type="text" class="form-control" id="fullName" placeholder="Full name" required>
              </div>
              <div class="col-md-6">
                <input type="tel" class="form-control" id="phone" placeholder="Phone number" required>
              </div>
              <div class="col-12">
                <input type="email" class="form-control" id="email" placeholder="Email address" required>
              </div>
              <div class="col-12">
                <input type="text" class="form-control" id="address1" placeholder="Address line 1" required>
              </div>
              <div class="col-12">
                <input type="text" class="form-control" id="address2" placeholder="Address line 2 (optional)">
              </div>
              <div class="col-md-6">
                <input type="text" class="form-control" id="city" placeholder="City" required>
              </div>
              <div class="col-md-6">
                <input type="text" class="form-control" id="postcode" placeholder="Postcode" required>
              </div>
            </div>

            <hr class="my-4">

            <h4 class="fw-semibold mb-3">Order summary</h4>
            <div id="order-summary"></div>

            <!-- Bundle info on checkout -->
            <div id="bundle-message" class="small text-warning mt-2"></div>
            <div class="d-flex justify-content-between small text-success mt-1"
                 id="bundle-row" style="display:none;">
              <span>Bundle discount</span>
              <span id="bundle-amount">-£0.00</span>
            </div>

            <div class="d-flex justify-content-between fs-4 fw-bold mt-3">
              <span>Total:</span>
              <span id="final-total">£0.00</span>
            </div>

            <button type="submit" class="btn btn-success btn-lg w-100 mt-4 rounded-pill">
              Confirm order → Payment details
            </button>
            <div id="checkout-status" class="small text-muted mt-2"></div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PAYMENT MODAL -->
<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Order confirmed</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-success">
          Thank you <strong id="customerName"></strong>! Your order has been recorded.
        </div>

        <h5 class="fw-semibold">Your order</h5>
        <div id="payment-summary" class="mb-3"></div>

        <h4 class="text-success mb-1">
          Total: <span id="payment-total"></span>
        </h4>
        <p id="payment-discount" class="text-success small mb-3" style="display:none;"></p>

        <p class="mb-1">
          Your payment reference:
          <strong id="order-ref" class="text-primary fw-bold"></strong>
        </p>

        <p class="text-muted mb-0">
          Order confirmed<br>
          <strong>Payment instructions have been sent to your email.</strong><br>
          Please use the reference code <strong>ONLY</strong> when making your bank transfer.<br><br>
          Thanks for choosing Lumina Weight.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-success" onclick="backToShop()">Back to shop</button>
      </div>
    </div>
  </div>
</div>

<!-- EmailJS + Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
  (function () {
    emailjs.init('uZOuTrBdIAc6AmKjo');
  })();

  const SUPABASE_URL = "https://qketnqhfjfxbqiuqevnh.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrZXRucWhmamZ4YnFpdXFldm5oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NjkzMzAsImV4cCI6MjA4MDI0NTMzMH0.JIrgLIwWIA5Gwu9K4BsgS0Y_jyax2G6irqkaf35aPys";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>

<script>
let cart = [];
let total = 0;

// ---------- ACCESSORY RULES ----------
function isSemaglutide(name){
  return (name || '').toLowerCase().includes('semaglutide') || (name || '').toLowerCase().includes('sema');
}

// We now allow "forced" form via item.sema_form when sema names don't include pen/vial
function isPenItem(itemOrName) {
  const item = (typeof itemOrName === 'object' && itemOrName) ? itemOrName : null;
  const name = item ? (item.name || '') : (itemOrName || '');
  const n = String(name).toLowerCase();

  // explicit override (for sema selector)
  const semaForm = item ? String(item.sema_form || '').toLowerCase().trim() : '';
  if (semaForm === 'pen') return true;

  // metadata-based (if you ever add these fields in cart)
  const form = item ? String(item.form || item.type || item.format || item.variant || '').toLowerCase() : '';
  if (form.includes('pen')) return true;

  return n.includes('pen') || n.includes('flexpen') || n.includes('cartridge');
}

function isVialItem(itemOrName) {
  const item = (typeof itemOrName === 'object' && itemOrName) ? itemOrName : null;
  const name = item ? (item.name || '') : (itemOrName || '');
  const n = String(name).toLowerCase();

  // explicit override (for sema selector)
  const semaForm = item ? String(item.sema_form || '').toLowerCase().trim() : '';
  if (semaForm === 'vial') return true;

  const form = item ? String(item.form || item.type || item.format || item.variant || '').toLowerCase() : '';
  if (form.includes('vial')) return true;

  return n.includes('vial');
}

function extraLabel(item) {
  const n = (item?.name || '').toLowerCase();
  if (isPenItem(item) && item.pen_heads) return ` (Pen heads: ${item.pen_heads === 'none' ? 'None required' : item.pen_heads})`;
  if (isVialItem(item) && item.syringes) return ` (Syringes: ${item.syringes === 'none' ? 'None required' : item.syringes})`;
  return '';
}

function saveCartToStorage() {
  try { localStorage.setItem('cart', JSON.stringify(cart)); } catch (e) {}
}

// NEW: sema form selector setter
function setSemaForm(index, value){
  if (!cart[index]) return;
  cart[index].sema_form = String(value || '').trim(); // 'pen' | 'vial' | ''
  // clear opposite accessory if switching
  if (cart[index].sema_form === 'pen') cart[index].syringes = "";
  if (cart[index].sema_form === 'vial') cart[index].pen_heads = "";
  saveCartToStorage();
  renderOrderSummary();
}

// called by dropdowns
function setAccessory(index, field, value) {
  if (!cart[index]) return;

  const v = (value || '').trim(); // '' if not selected
  if (field === 'pen_heads') cart[index].pen_heads = v;
  if (field === 'syringes')  cart[index].syringes  = v;

  saveCartToStorage();
  renderOrderSummary();
}

// Validate mandatory selections
function validateAccessories() {
  const missing = [];

  cart.forEach((item) => {
    const n = (item?.name || '').toLowerCase();

    // If SEMAGLUTIDE item doesn't clearly say pen/vial, force them to pick
    const sema = isSemaglutide(n);
    const clearlyPen  = isPenItem(item);
    const clearlyVial = isVialItem(item);
    const needsSemaChoice = sema && !clearlyPen && !clearlyVial;

    if (needsSemaChoice && !String(item.sema_form || '').trim()) {
      missing.push(`Select Semaglutide type for: ${item.name}`);
      return;
    }

    // must be chosen (including 'none')
    if (isPenItem(item) && !String(item.pen_heads || '').trim()) {
      missing.push(`Select Pen heads for: ${item.name}`);
    }
    if (isVialItem(item) && !String(item.syringes || '').trim()) {
      missing.push(`Select Syringes for: ${item.name}`);
    }
  });

  return missing;
}

// ---------- PRICE SYNC (IMPORTANT) ----------
async function syncCartPricesFromSupabase() {
  try {
    const ids = cart.map(i => i.id).filter(Boolean);
    if (!ids.length) return;

    const { data, error } = await supabaseClient
      .from('Products')
      .select('id, name, price')
      .in('id', ids);

    if (error) {
      console.error('Price sync failed:', error);
      return;
    }

    const map = new Map((data || []).map(p => [p.id, p]));

    cart = cart.map(item => {
      const p = map.get(item.id);
      if (!p) return item;

      return {
        ...item,
        name: p.name || item.name,
        price: Number(p.price || 0)
      };
    });

    saveCartToStorage();
  } catch (e) {
    console.error('Unexpected price sync error:', e);
  }
}

// ---------- BUNDLE CALCULATOR ----------
function calculateBundle(cart) {
  let vialQty = 0, penQty = 0;
  let vialTotal = 0, penTotal = 0, otherTotal = 0;

  let totalQty = 0;
  let baseTotal = 0;

  cart.forEach(item => {
    const qty  = Number(item.qty || 0);
    const line = Number(item.price || 0) * qty;
    const name = (item.name || '').toLowerCase();

    totalQty += qty;
    baseTotal += line;

    if (name.includes('vial') || isVialItem(item)) {
      vialQty += qty;
      vialTotal += line;
    } else if (name.includes('pen') || isPenItem(item)) {
      penQty += qty;
      penTotal += line;
    } else {
      otherTotal += line;
    }
  });

  // --- Existing category discounts ---
  let categoryDiscount = 0;
  const categoryMessages = [];

  if (vialQty >= 3) {
    const d = vialTotal * 0.10;
    categoryDiscount += d;
    categoryMessages.push('10% multi-vial bundle discount applied.');
  } else if (vialQty === 2) {
    const d = vialTotal * 0.05;
    categoryDiscount += d;
    categoryMessages.push('5% vial bundle discount applied (2 vials).');
  }

  if (penQty >= 3) {
    const d = penTotal * 0.10;
    categoryDiscount += d;
    categoryMessages.push('10% pen bundle discount applied (3+ pens).');
  } else if (penQty === 2) {
    const d = penTotal * 0.05;
    categoryDiscount += d;
    categoryMessages.push('5% pen bundle discount applied (2 pens).');
  }

  // --- Cart-level discount (any 2 = 5%, any 3+ = 10%) ---
  let cartDiscount = 0;
  let cartMessage = '';

  if (totalQty >= 3) {
    cartDiscount = baseTotal * 0.10;
    cartMessage = '10% bundle discount applied (any 3+ items).';
  } else if (totalQty === 2) {
    cartDiscount = baseTotal * 0.05;
    cartMessage = '5% bundle discount applied (any 2 items).';
  }

  // --- Choose best single discount (NO STACKING) ---
  let discount = 0;
  const messages = [];

  if (cartDiscount >= categoryDiscount && cartDiscount > 0) {
    discount = cartDiscount;
    messages.push(cartMessage);
  } else if (categoryDiscount > 0) {
    discount = categoryDiscount;
    messages.push(...categoryMessages);
  }

  const finalTotal = Math.max(0, baseTotal - discount);

  return { baseTotal, discount, finalTotal, messages };
}

// ---------- CART / RECOVERY HELPERS ----------
function getCartFromUrlOrStorage() {
  const params = new URLSearchParams(window.location.search);
  const urlCart = params.get('cart');
  if (urlCart) {
    try {
      const parsed = JSON.parse(decodeURIComponent(urlCart));
      localStorage.setItem('cart', JSON.stringify(parsed));
      return parsed;
    } catch (e) {
      console.error('Error parsing cart from URL', e);
    }
  }
  try {
    const saved = localStorage.getItem('cart');
    if (saved) return JSON.parse(saved);
  } catch (e) {
    console.error('Error reading cart from localStorage', e);
  }
  return [];
}

async function maybeRecoverCart() {
  const params = new URLSearchParams(window.location.search);
  const token = params.get('recover');
  if (!token) return;

  try {
    const { data, error } = await supabaseClient
      .from('AbandonedCheckouts')
      .select('cart, status')
      .eq('recovery_token', token)
      .single();

    if (error) {
      console.error('Recovery token lookup failed', error);
      return;
    }

    if (data && data.cart) {
      localStorage.setItem('cart', JSON.stringify(data.cart));

      await supabaseClient
        .from('AbandonedCheckouts')
        .update({ status: 'recovered' })
        .eq('recovery_token', token);

      const url = new URL(window.location.href);
      url.searchParams.delete('recover');
      url.searchParams.delete('cart');
      window.history.replaceState({}, '', url.toString());
    }
  } catch (e) {
    console.error('Unexpected recovery error', e);
  }
}

// Dropdown HTML (mandatory + includes None required)
function accessoryDropdownHTML(item, index) {
  const name = item?.name || '';
  const n = String(name).toLowerCase();
  const sema = isSemaglutide(n);

  const penDetected = isPenItem(item);
  const vialDetected = isVialItem(item);

  // If it's sema but neither pen/vial is detectable from name/fields, force a choice
  if (sema && !penDetected && !vialDetected) {
    const currentForm = item.sema_form ? String(item.sema_form) : '';
    return `
      <div class="addon-row d-flex align-items-center justify-content-between">
        <label class="m-0">Semaglutide type <span class="text-danger">*</span></label>
        <select class="form-select form-select-sm" style="max-width: 220px;" required
          onchange="setSemaForm(${index}, this.value)">
          <option value="" ${currentForm === '' ? 'selected' : ''} disabled>Select…</option>
          <option value="pen" ${currentForm === 'pen' ? 'selected' : ''}>Pen (needs pen heads)</option>
          <option value="vial" ${currentForm === 'vial' ? 'selected' : ''}>Vial (needs syringes)</option>
        </select>
      </div>
      ${currentForm ? accessoryDropdownHTML({ ...item, sema_form: currentForm }, index) : ''}
    `;
  }

  if (isPenItem(item)) {
    const current = item.pen_heads ? String(item.pen_heads) : '';
    return `
      <div class="addon-row d-flex align-items-center justify-content-between">
        <label class="m-0">Pen heads <span class="text-danger">*</span></label>
        <select class="form-select form-select-sm" style="max-width: 180px;" required
          onchange="setAccessory(${index}, 'pen_heads', this.value)">
          <option value="" ${current === '' ? 'selected' : ''} disabled>Select…</option>
          <option value="none" ${current === 'none' ? 'selected' : ''}>None required</option>
          <option value="5" ${current === '5' ? 'selected' : ''}>5</option>
          <option value="10" ${current === '10' ? 'selected' : ''}>10</option>
        </select>
      </div>
    `;
  }

  if (isVialItem(item)) {
    const current = item.syringes ? String(item.syringes) : '';
    return `
      <div class="addon-row d-flex align-items-center justify-content-between">
        <label class="m-0">Syringes <span class="text-danger">*</span></label>
        <select class="form-select form-select-sm" style="max-width: 180px;" required
          onchange="setAccessory(${index}, 'syringes', this.value)">
          <option value="" ${current === '' ? 'selected' : ''} disabled>Select…</option>
          <option value="none" ${current === 'none' ? 'selected' : ''}>None required</option>
          <option value="5" ${current === '5' ? 'selected' : ''}>5</option>
          <option value="10" ${current === '10' ? 'selected' : ''}>10</option>
        </select>
      </div>
    `;
  }

  return '';
}

function renderOrderSummary() {
  if (!cart.length) return;

  const bundle = calculateBundle(cart);
  total = bundle.finalTotal;

  const summaryEl       = document.getElementById('order-summary');
  const totalEl         = document.getElementById('final-total');
  const bundleRow       = document.getElementById('bundle-row');
  const bundleAmountEl  = document.getElementById('bundle-amount');
  const bundleMessageEl = document.getElementById('bundle-message');

  summaryEl.innerHTML = cart.map((i, idx) => `
    <div class="py-2 border-bottom">
      <div class="d-flex justify-content-between">
        <span>${i.qty} × ${i.name}${extraLabel(i)}</span>
        <span>£${(Number(i.price || 0) * Number(i.qty || 0)).toFixed(2)}</span>
      </div>
      ${accessoryDropdownHTML(i, idx)}
    </div>
  `).join('');

  if (bundle.discount > 0) {
    bundleRow.style.display = 'flex';
    bundleAmountEl.textContent = `-£${bundle.discount.toFixed(2)}`;
    bundleMessageEl.textContent = bundle.messages.join(' ');
  } else {
    bundleRow.style.display = 'none';
    bundleAmountEl.textContent = '-£0.00';
    bundleMessageEl.textContent = '';
  }

  totalEl.textContent = `£${bundle.finalTotal.toFixed(2)}`;
}

function buildItemsText() {
  if (!cart.length) return 'No items (cart empty).';
  return cart.map(i => {
    const base = `${i.qty} × ${i.name}${extraLabel(i)} — £${(Number(i.price || 0) * Number(i.qty || 0)).toFixed(2)}`;
    return base;
  }).join('\n');
}

function buildAddressText(details) {
  return [details.address1, details.address2, details.city, details.postcode]
    .filter(Boolean).join('\n');
}

function clearStoredCart() {
  try { localStorage.removeItem('cart'); } catch (e) {}
}

function createRecoveryToken() {
  if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
  return 'token_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
}

async function saveOrderToSupabase(details) {
  try {
    const { data, error } = await supabaseClient.auth.getUser();
    const userId = (error || !data || !data.user) ? null : data.user.id;

    const orderDetails = {
      customer: {
        name: details.name,
        email: details.email,
        phone: details.phone,
        address1: details.address1,
        address2: details.address2,
        city: details.city,
        postcode: details.postcode
      },
      items: cart.map(i => ({
        id: i.id || null,
        name: i.name,
        qty: i.qty,
        price_each: Number(i.price || 0),
        line_total: Number(i.price || 0) * Number(i.qty || 0),
        pen_heads: i.pen_heads || "",
        syringes: i.syringes || "",
        sema_form: i.sema_form || ""   // NEW: saved for semaglutide items
      })),
      reference: details.ref
    };

    const { error: insertError } = await supabaseClient
      .from('Orders')
      .insert({
        user_id: userId,
        total_amount: total,
        status: 'Pending',
        reference: details.ref,
        details: orderDetails
      });

    if (insertError) console.error('Error saving order to Supabase:', insertError);
  } catch (err) {
    console.error('Unexpected error saving order to Supabase:', err);
  }
}

// UPDATED: stock deduction by product ID (not name)
async function deductStock(cartItems) {
  try {
    const ids = cartItems.map(i => i.id).filter(Boolean);
    if (!ids.length) return;

    const { data: products, error: fetchError } = await supabaseClient
      .from('Products')
      .select('id, stock')
      .in('id', ids);

    if (fetchError) {
      console.error('Error fetching products:', fetchError);
      return;
    }

    for (const cartItem of cartItems) {
      const product = (products || []).find(p => p.id === cartItem.id);
      if (!product) continue;

      const newStock = Math.max(0, (product.stock || 0) - Number(cartItem.qty || 0));

      const { error: updateError } = await supabaseClient
        .from('Products')
        .update({ stock: newStock })
        .eq('id', product.id);

      if (updateError) console.error(`Error updating stock for ${cartItem.name}:`, updateError);
    }
  } catch (err) {
    console.error('Unexpected error deducting stock:', err);
  }
}

async function saveAbandonedCheckout(details, recoveryToken) {
  try {
    const { error } = await supabaseClient
      .from('AbandonedCheckouts')
      .insert({
        email: details.email,
        name: details.name,
        cart,
        recovery_token: recoveryToken,
        status: 'pending',
        total_amount: total,
        reference: details.ref
      });

    if (error) console.error('Error saving abandoned checkout:', error);
  } catch (e) {
    console.error('Unexpected error saving abandoned checkout', e);
  }
}

// ---------- EMAILS (return promises) ----------
function sendAdminEmail(details) {
  const itemsText = buildItemsText();
  const addressText = buildAddressText(details);

  return emailjs.send('service_i5zi096', 'template_juevvvd', {
    to_email: 'luminaweight@gmail.com',
    customer_name: details.name,
    customer_phone: details.phone,
    customer_address: addressText,
    order_reference: details.ref,
    order_items: itemsText,
    order_total: `£${total.toFixed(2)}`
  });
}

function sendCustomerEmail(details) {
  const itemsText = buildItemsText();
  const addressText = buildAddressText(details);

  return emailjs.send('service_i5zi096', 'template_x5lnd1u', {
    to_email: details.email,
    customer_email: details.email,
    customer_name: details.name,
    customer_address: addressText,
    order_reference: details.ref,
    order_items: itemsText,
    order_total: `£${total.toFixed(2)}`
  });
}

function sendAbandonedEmail(details, recoveryLink) {
  const cartSummary = buildItemsText();

  return emailjs.send('service_i5zi096', 'template_guh3ord', {
    to_email: details.email,
    customer_name: details.name || 'there',
    order_items: cartSummary,
    recovery_link: recoveryLink
  });
}

// ---------- FORM SUBMIT ----------
const checkoutStatus = document.getElementById('checkout-status');

document.getElementById('addressForm').onsubmit = async function(e) {
  e.preventDefault();

  const btn = this.querySelector('button[type="submit"]');

  const name = document.getElementById('fullName').value.trim() || 'Customer';
  const phone = document.getElementById('phone').value.trim();
  const email = document.getElementById('email').value.trim();
  const address1 = document.getElementById('address1').value.trim();
  const address2 = document.getElementById('address2').value.trim();
  const city = document.getElementById('city').value.trim();
  const postcode = document.getElementById('postcode').value.trim();
  const ref = 'LW' + Date.now().toString().slice(-6);

  if (!email || !cart.length) {
    checkoutStatus.textContent = 'Please ensure your cart and email are valid.';
    checkoutStatus.classList.add('text-danger');
    return;
  }

  // block if mandatory dropdowns not selected
  const missing = validateAccessories();
  if (missing.length) {
    checkoutStatus.textContent = missing[0];
    checkoutStatus.classList.add('text-danger');
    return;
  }

  // IMPORTANT: refresh prices right before totals + order save
  await syncCartPricesFromSupabase();
  renderOrderSummary();

  const bundle = calculateBundle(cart);
  total = bundle.finalTotal;

  const details = { name, phone, email, address1, address2, city, postcode, ref };

  // Fill modal
  document.getElementById('customerName').textContent = name;
  document.getElementById('payment-summary').innerHTML = cart.map(i => `
    <div class="d-flex justify-content-between">
      <span>${i.qty} × ${i.name}${extraLabel(i)}</span>
      <span>£${(Number(i.price || 0) * Number(i.qty || 0)).toFixed(2)}</span>
    </div>
  `).join('');
  document.getElementById('payment-total').textContent = `£${total.toFixed(2)}`;

  const paymentDiscountEl = document.getElementById('payment-discount');
  if (bundle.discount > 0) {
    paymentDiscountEl.style.display = 'block';
    paymentDiscountEl.textContent = `Bundle discount applied: -£${bundle.discount.toFixed(2)}`;
  } else {
    paymentDiscountEl.style.display = 'none';
    paymentDiscountEl.textContent = '';
  }

  document.getElementById('order-ref').textContent = ref;

  const recoveryToken = createRecoveryToken();
  const recoveryLink  = `https://luminaweight.co.uk/checkout.html?recover=${encodeURIComponent(recoveryToken)}`;

  checkoutStatus.textContent = '';
  checkoutStatus.classList.remove('text-danger', 'text-success');

  btn.disabled = true;
  btn.textContent = 'Processing...';

  try {
    // 1) Save order
    await saveOrderToSupabase(details);

    // 2) Deduct stock (by ID)
    await deductStock(cart);

    // 3) Save abandoned checkout
    await saveAbandonedCheckout(details, recoveryToken);

    // 4) Send emails
    const emailResults = await Promise.allSettled([
      sendAdminEmail(details),
      sendCustomerEmail(details),
      sendAbandonedEmail(details, recoveryLink)
    ]);
    console.log('EmailJS results:', emailResults);

    // 5) Clear cart
    clearStoredCart();

    // 6) Show success modal
    const modalEl = document.getElementById('paymentModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();

    checkoutStatus.textContent = "We've emailed your payment instructions and order link.";
    checkoutStatus.classList.add('text-success');

  } catch (err) {
    console.error('Checkout flow error', err);
    checkoutStatus.textContent = 'There was a problem handling your order. Please try again.';
    checkoutStatus.classList.add('text-danger');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Confirm order → Payment details';
  }
};

function backToShop() {
  window.location.href = 'index.html';
}

// ---------- INIT ----------
(async function initCheckout() {
  await maybeRecoverCart();
  cart = getCartFromUrlOrStorage();

  if (!cart.length) {
    alert('Your cart is empty! Taking you back to the shop.');
    window.location.href = 'index.html';
    return;
  }

  // ensure cart has extras keys (mandatory dropdowns use blank = not selected)
  cart = cart.map(i => ({
    ...i,
    pen_heads: i.pen_heads || "",
    syringes: i.syringes || "",
    sema_form: i.sema_form || ""   // NEW
  }));
  saveCartToStorage();

  // IMPORTANT: sync current prices from Supabase before rendering totals
  await syncCartPricesFromSupabase();

  renderOrderSummary();
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

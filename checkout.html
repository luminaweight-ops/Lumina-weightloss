<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout - Lumina Weight</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  :root {
    --lw-mint: #22c55e;
    --lw-mint-soft: #ecfdf5;
    --lw-blue-soft: #e0f2fe;
    --lw-purple-soft: #eef2ff;
    --lw-dark: #0f172a;
    --lw-muted: #64748b;
    --lw-bg: #f3f4f6;
  }

  body {
    background: var(--lw-bg);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }

  .hero {
    background: radial-gradient(circle at top left, var(--lw-mint-soft), #e0f2fe 40%, var(--lw-purple-soft) 100%);
    color: var(--lw-dark);
    padding: 80px 0 70px;
    text-align: center;
  }
  .hero h1 {
    font-weight: 800;
  }
  .hero p {
    color: var(--lw-muted);
    max-width: 500px;
    margin: 0 auto 10px;
  }
  .btn-outline-light {
    border-radius: 999px;
    border-color: rgba(148,163,184,0.6);
    color: var(--lw-muted);
  }
  .btn-outline-light:hover {
    background: #ffffff;
    color: var(--lw-dark);
  }

  .card {
    border-radius: 24px;
    border: 0;
    box-shadow: 0 20px 45px rgba(15,23,42,0.10);
  }

  .form-control {
    border-radius: 12px;
  }

  #final-total {
    color: #16a34a;
  }

  .modal-content {
    border-radius: 20px;
  }
  .modal-header {
    background: var(--lw-mint);
    color: #ffffff;
  }
</style>
</head>
<body>

<div class="hero">
  <div class="container">
    <h1 class="display-5 fw-bold">Checkout</h1>
    <p>Enter your delivery details so we can generate your order reference and payment info.</p>
    <button class="btn btn-outline-light btn-sm mt-2" onclick="backToShop()">‚Üê Back to shop</button>
  </div>
</div>

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body p-5">
          <form id="addressForm">
            <h4 class="mb-4 fw-semibold">Delivery address</h4>
            <div class="row g-3">
              <div class="col-md-6">
                <input type="text" class="form-control" id="fullName" placeholder="Full name" required>
              </div>
              <div class="col-md-6">
                <input type="tel" class="form-control" id="phone" placeholder="Phone number" required>
              </div>
              <div class="col-12">
                <input type="email" class="form-control" id="email" placeholder="Email address" required>
              </div>
              <div class="col-12">
                <input type="text" class="form-control" id="address1" placeholder="Address line 1" required>
              </div>
              <div class="col-12">
                <input type="text" class="form-control" id="address2" placeholder="Address line 2 (optional)">
              </div>
              <div class="col-md-6">
                <input type="text" class="form-control" id="city" placeholder="City" required>
              </div>
              <div class="col-md-6">
                <input type="text" class="form-control" id="postcode" placeholder="Postcode" required>
              </div>
            </div>

            <hr class="my-4">

            <h4 class="fw-semibold mb-3">Order summary</h4>
            <div id="order-summary"></div>
            <div class="d-flex justify-content-between fs-4 fw-bold mt-3">
              <span>Total:</span>
              <span id="final-total">¬£0.00</span>
            </div>

            <button type="submit" class="btn btn-success btn-lg w-100 mt-4 rounded-pill">
              Confirm order ‚Üí Payment details
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PAYMENT MODAL -->
<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Order confirmed</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-success">
          Thank you <strong id="customerName"></strong>! Your order has been recorded.
        </div>

        <h5 class="fw-semibold">Your order</h5>
        <div id="payment-summary" class="mb-3"></div>

        <h4 class="text-success mb-3">
          Total: <span id="payment-total"></span>
        </h4>

        <p class="mb-1">
          Your payment reference: 
          <strong id="order-ref" class="text-primary fw-bold"></strong>
        </p>
        <p class="text-muted mb-0">
          Order confirmed 
Payment instructions have been sent to your email.
Please use the reference code below when making your bank transfer.

Thanks for choosing Lumina Weight.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-success" onclick="backToShop()">Back to shop</button>
      </div>
    </div>
  </div>
</div>

<!-- EmailJS library -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
  (function() {
    emailjs.init('uZOuTrBdIAc6AmKjo');
  })();
</script>

<script>
// --------------- CART FROM URL ---------------
function getCart() {
  const params = new URLSearchParams(window.location.search);
  const data = params.get('cart');
  if (data) {
    try { return JSON.parse(decodeURIComponent(data)); }
    catch(e) { console.error(e); }
  }
  return [];
}

const cart = getCart();
if (cart.length === 0) {
  alert('Your cart is empty! Taking you back to the shop.');
  window.location.href = 'index.html';
}

const total = cart.reduce((s, i) => s + i.price * i.qty, 0);

document.getElementById('order-summary').innerHTML = cart.map(i => `
  <div class="d-flex justify-content-between py-2 border-bottom">
    <span>${i.qty} √ó ${i.name}</span>
    <span>¬£${(i.price * i.qty).toFixed(2)}</span>
  </div>
`).join('');
document.getElementById('final-total').textContent = `¬£${total.toFixed(2)}`;

// --------------- HELPERS ---------------
function buildItemsText() {
  return cart.map(i => `${i.qty} √ó ${i.name} ‚Äî ¬£${(i.price * i.qty).toFixed(2)}`).join('\n');
}

function buildAddressText(details) {
  return [
    details.address1,
    details.address2,
    details.city,
    details.postcode
  ].filter(Boolean).join('\n');
}

function clearStoredCart() {
  try {
    localStorage.removeItem('cart');
  } catch (e) {
    console.warn('Could not clear localStorage cart', e);
  }
}

// --------------- EMAILS ---------------

// üì• ADMIN EMAIL TO YOU ‚Äì template_juevvvd
function sendAdminEmail(details) {
  const itemsText = buildItemsText();
  const addressText = buildAddressText(details);

  emailjs.send(
    'service_i5zi096',
    'template_juevvvd',
    {
      to_email: 'luminaweight@gmail.com',        // recipient = you
      customer_name: details.name,
      customer_phone: details.phone,
      customer_address: addressText,
      order_reference: details.ref,
      order_items: itemsText,
      order_total: `¬£${total.toFixed(2)}`
    }
  )
  .then(res => console.log('‚úÖ Admin order email sent', res.status))
  .catch(err => console.error('‚ùå Admin email failed', err));
}

// üßë‚Äçüíª CUSTOMER EMAIL ‚Äì template_x5lnd1u
function sendCustomerEmail(details) {
  const itemsText = buildItemsText();
  const addressText = buildAddressText(details);

  emailjs.send(
    'service_i5zi096',
    'template_x5lnd1u',
    {
      to_email: details.email,                  // main recipient
      customer_email: details.email,            // spare var if template uses this
      customer_name: details.name,
      customer_address: addressText,
      order_reference: details.ref,
      order_items: itemsText,
      order_total: `¬£${total.toFixed(2)}`
    }
  )
  .then(res => console.log('‚úÖ Customer confirmation email sent', res.status))
  .catch(err => console.error('‚ùå Customer email failed', err));
}

// --------------- FORM SUBMIT ---------------
document.getElementById('addressForm').onsubmit = function(e) {
  e.preventDefault();

  const name = document.getElementById('fullName').value.trim() || 'Customer';
  const phone = document.getElementById('phone').value.trim();
  const email = document.getElementById('email').value.trim();
  const address1 = document.getElementById('address1').value.trim();
  const address2 = document.getElementById('address2').value.trim();
  const city = document.getElementById('city').value.trim();
  const postcode = document.getElementById('postcode').value.trim();
  const ref = 'LW' + Date.now().toString().slice(-6);

  const details = { name, phone, email, address1, address2, city, postcode, ref };

  // Fill modal
  document.getElementById('customerName').textContent = name;
  document.getElementById('payment-summary').innerHTML = cart.map(i => `
    <div class="d-flex justify-content-between">
      <span>${i.qty} √ó ${i.name}</span>
      <span>¬£${(i.price*i.qty).toFixed(2)}</span>
    </div>
  `).join('');
  document.getElementById('payment-total').textContent = `¬£${total.toFixed(2)}`;
  document.getElementById('order-ref').textContent = ref;

  // Send emails
  sendAdminEmail(details);
  sendCustomerEmail(details);

  // Clear cart storage so basket is empty when back on main page
  clearStoredCart();

  // Show modal
  new bootstrap.Modal(document.getElementById('paymentModal')).show();
};

function backToShop() {
  window.location.href = 'index.html';
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
